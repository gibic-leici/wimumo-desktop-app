<!DOCTYPE html>
<html lang="en">
<script src="FileSaver.js"></script>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<link rel="icon" href="favicon.ico">
<link rel="stylesheet" href="basic.min.css">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
  :root {
    --rc: 1px;
  }

  body {
    background-color: var(--c2);
  }

  article {
    box-shadow: 0px 0px 0px rgba(0, 0, 0, 0.3);
  }

  button.nav {
    width: 100%;
  }

  canvas {
    border: 1px solid #000000;
    background-color: white;
    color: white;
    border-radius: 2px;
    margin: 10px;
  }

  #rec {
    background-color: darkred;
    border: 0px;
    margin: 10px;
    border-radius: 1rem;
    font-size: small;
    padding: 1rem;
  }
</style>

<head>

  <meta name="description" content="WIMUMO">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>WIMUMO</title>
</head>

<body>

  <main>
    <section>
      <section>
        <article>
          <button class="nav" id="butInstrucciones" onclick="cambiarNav(this.id)">Instrucciones</button>
          <button class="nav" id="butConfiguracion" onclick="cambiarNav(this.id)">Configuración</button>
          <button class="nav" id="butVerSenales" onclick="cambiarNav(this.id)">Ver señales</button>
          <button class="nav" id="butMusica" onclick="cambiarNav(this.id)">Música</button>
          <button class="nav" id="butRerouter" onclick="cambiarNav(this.id)">Ruteo OSC</button>
        </article>
      </section>
      <section style="--c:4">
        <article id="Instrucciones">
          <p>Aquí se explica cómo configurar WIMUMO y su uso básico. Para más información
            puede consultar la página del proyecto en
            https://gibic.ing.unlp.edu.ar/wumumo
          </p>

          <h3>Instrucciones rápidas</h3>
          <ol>
            <li>
              Encienda WIMUMO. Tras unos segundos, verá que la luz indicadora parpadea rápidamente
              con colores, esto indica que está en "modo configuración". Si WIMUMO no está en este modo,
              puede cambiarlo presionando el pulsador.
            </li>
            <li>
              Busque la red WiFi WIMUMOxxx, conéctese y navegue a la dirección <mark>192.168.0.2</mark>
            </li>
            <li>
              Ingrese a "Configurar Red" para ingresar los datos de la red WiFi a donde conectará WIMUMO.
            </li>
            <li>
              Ingrese a "Configurar OSC" para ingresar el destino de los paquetes OSC. Para usar esta
              aplicación debe ingresar <mark>su IP local</mark> y el puerto <mark>4560</mark>.
            </li>
            <li>
              Presione el pulsador para cambiar al modo de uso normal. Si WIMUMO logró conectarse a
              la red verá el led titilar lentamente.
            </li>
          </ol>

          <h3>Instrucciones paso a paso explicadas</h3>

          <p>WIMUMO tiene una tecla de encendido, un botón de configuración y una luz
            indicadora.</p>

          <p>La primera vez que use WIMUMO, deberá conectarlo a la red WiFi.
            El procedimiento es muy similar a conectar su celular o computadora al WiFi,
            pero como WIMUMO no tiene pantalla ni teclado, involucra algunos pasos
            adicionales. La red WiFi debe ser la misma a donde está conectado el dispositivo
            que recibirá los datos de WIMUMO (por ejemplo, donde ve esta aplicación).</p>

          <p>Todos los dispositivos que se conectan a la red tienen una identificación
            que se llama <em>dirección IP</em>. La computadora, el celular, y WIMUMO,
            cada uno tiene su IP.
            WIMUMO funciona enviando datos a un dispositivo de la red, y por lo tanto
            necesita su IP para saber a dónde enviar los datos.
          </p>

          <ol>

            <li>Asegúrese de tomar nota de los datos de su red WiFi (nombre y contraseña).
              No sólo deberá dárselas a WIMUMO, sino que al finalizar el procedimiento debe
              volver a conectarse a su red. Encienda WIMUMO.
              Tras unos segundos, verá que la luz indicadora parpadea rápidamente
              con colores.</li>

            <li>Conéctese a WIMUMO para configurarlo.
              Puede hacerlo desde una notebook, celular, o Tablet,
              aunque es más fácil hacerlo desde una notebook
              (en ese caso puede saltear el próximo paso). </li>

            <li>Para configurar WIMUMO desde un celular:
              <ol>
                <li>Ponga a su celular en “modo avión” </li>
                <li>Active el WiFi (sólo el WiFi, no desactive el modo avión)</li>
              </ol>

            <li>Busque la red WiFi WIMUMOxxx y conéctese
              (xxx es un código numérico particular de cada WIMUMO, por ejemplo WIMUMO023).
              Puede tardar algunos segundos, observe que la conexión se completa y si
              no es así, inténtelo de nuevo. </li>

            <li>Abra su navegador web (Google Chrome, o lo que use habitualmente
              para acceder a internet o buscar en google) e ingrese en la barra
              de direcciones: <mark>192.168.0.2</mark></li>

            <li>Debe aparecer una página dándole la bienvenida a la configuración de WIMUMO.
              Si no aparece, espere unos segundos, inténtelo de nuevo, y eventualmente
              chequee si se conectó correctamente al WiFi de WIMUMO.</li>

            <li>Ingrese a “Configurar Red” donde verá los casilleros donde ingresar nobre
              de red y contraseña. Hágalo y presione “Aplicar”.</li>
            <ol>
              <li>Avanzado: Si necesita configurar un IP fijo, puede hacerlo, si no,
                puede dejar todo vacío.</li>
            </ol>
            <li>Ingrese a "Configurar OSC" e ingrese la IP de la computadora donde desea
              enviar las señales OSC y el puerto, luego presione "Enviar Datos". Si desea
              usar WIMUMO desde esta aplicación, la dirección IP deberá ser la de esta
              computadora <span id="instrucciones_iplocal"> </span> y en "puerto" debe
              ingresar <mark>4560</mark>. </li>

            <li>¡Listo! El proceso de configuración terminó. Presione el pulsador de “modo” de WIMUMO. El sistema se
              reiniciará y
              si todo salió bien, verá la luz parpadear lentamente.
              ¡Su WIMUMO ya está configurado! Si en cambio vuelve a parpadear rápidamente,
              significa que algo salió mal y continúa en “modo configuración”. Pruebe
              conectarse nuevamente y reingresar los datos de la red. </li>

            <li>Recuerde volver a conectar su computadora a la red.
              Si realizó la configuración con un celular, recuerde desactivar
              el modo avión para que su celular vuelva a funcionar normalmente.</li>
          </ol>

          <p>
            Si lleva su WIMUMO a un lugar nuevo con una red que no está cargada en WIMUMO,
            al encenderse se prenderá en el modo de configuración automáticamente
            y puede comenzar en el paso 1. Si su WIMUMO está conectado a una red,
            pero necesita cambiar la configuración, presione el pulsador de “modo” y WIMUMO
            se reiniciará en el modo de configuración.
          </p>

          <h3> Uso de WIMUMO</h3>

          <p>
            WIMUMO tiene electrodos que miden señales eléctricas del cuerpo. Si los coloca
            sobre su cuerpo (con los contactos metálicos apoyados sobre la piel en una zona
            libre de pelo) podrá visualizar la actividad eléctrica de los músculos que se
            encuentren en ese lugar, cuando se contraigan. Si los apoya en su pecho incluso
            puede visualizar los latidos del corazón.
          </p>

          <p>
            WIMUMO envía los datos de las señales que mide usando el protocolo OSC. Este protocolo
            es muy utilizado en programas de generación de multimedia. Con esta aplicación
            podrá ver las señales y controlar tonos musicales, pero sacará mayor provecho a WIMUMO
            creando lo que desee con aplicaciones tales como puredata y la muy conocida
            Processing ( https://processing.org/ ). En la página del proyecto
            https://gibic.ing.unlp.edu.ar/wumumo encontrará algunos
            ejemplos de Processing para comenzar a usar WIMUMO.
          </p>

          <p>
            WIMUMO funciona con baterías de litio recargables tipo 14500 de 3.7 V. Si bien tienen
            el mismo tamaño, <mark>son distintas de las pilas AA comunes</mark>, y no funcionará si se
            intentan utilizar. Cuando la batería está baja, la luz indicadora titilará en rojo y
            debe retirarse la batería del quipo y recargarla.
          </p>

          <p>
            <a href="http://gibic.ar/">GIBIC</a>, 2021.<br>Grupo de Instrumentación Biomédica, Industrial y Científica.
            <br>Instituto <b>LEICI</b> (UNLP-CONICET-CIC).
          </p>
          </p>
        </article>
        <article id="Configuracion">
          <h3>Estado de WIMUMO</h3>
          <p id="estado">
          </p>
        </article>
        <article id="VerSenales">

          <canvas id="myCanvas1" width="400" height="200">
          </canvas>
          <label for="myCanvas1" id="cursorLabel"></label>
          <br>
          <button onclick="buttonScaleUp()">Zoom IN</button>
          <button onclick="buttonScaleDown()">Zoom OUT</button>

          <p id="parrafoCanales">

          </p>
          <p>
            <button id="rec" onclick="toggleGrabacion()">Grabar</button>
            <button onclick="buttonDescargar()">Guardar registro</button>
          </p>
        </article>
        <article id="Musica">
          <p>
            <button class="vumetro" id="ch1">1</button>
            <input type="range" list="tickmarks" min="0" max="1000" value="250" class="slider" id="sch1">
          </p>
          <p>
            <button class="vumetro" id="ch2">2</button>
            <input type="range" list="tickmarks" min="0" max="1000" value="250" class="slider" id="sch2">
          </p>


          <p>
            <button id="audioEN" onclick="habilitarAudio()">Audio OFF</button>
          </p>

          <datalist id="tickmarks">
            <option value="0"></option>
          </datalist>
        </article>
        <article id="Rerouter">
          <h3>Re-ruteo de paquetes OSC</h3>

          <p>
            <input onchange="updatedest(this)" type="radio" id="reoute-construct" name="selection-dest" value="dest-construct" checked>
            <label for="reoute-construct">Construct 3</label><br>
            <input onchange="updatedest(this)"  type="radio" id="reroute-processing-p5js" name="selection-dest" value="dest-processing-p5js">
            <label for="reroute-processing-p5js">Processing (<mark>sólo modo p5.js</mark>)</label><br>
          </p>

        </article>
      </section>
    </section>
  </main>
  <script src="renderer.js"></script>
  <script src="graficos.js"></script>
  <script src="music.js"></script>
  <script src="auxproc.js"></script>
  <script>
    // Esto debería ir en renderer.js, pero 
    // las funciones que usan elementos de 
    // graficos.js las pongo acá para que se vean 
    // todos entre sí porque si no tendría que hacer 
    // un múdulo para importar en 
    // renderer.js... creo?

    cargarCanvas(document.getElementById("myCanvas1"), document.getElementById("cursorLabel"));

    // Todos los canales (como "osc") que se quieran usar
    // deben habilitarse en preload.js
    var info_received = false;
    var ruta_base = "/wimumo020"
    var chan = ruta_base + "/raw/ch1";
    var posiblesChans = [];
    var numch = 0;
    var filt_batt = new Movprom(15);
    window.api.receive("osc", (data) => {

      if (data == "undefined") return;

      if (data[0] == ruta_base + "/env/ch1" && audioEnabled == true) {
        actualizarValor(1, parseInt(data[1]));
      }
      if (data[0] == ruta_base + "/env/ch2" && audioEnabled == true) {
        actualizarValor(2, parseInt(data[1]));
      }


      if (data[0] == chan) {

        var mu = [];
        var i = 0;
        for (i = 1; i < data.length; i++) {
          mu.push(parseInt(data[i]));
        }

        graficar(mu);
      }


      if (info_received == false && data[0].substring(11, 15) == "info") {
        info_received = true;
        ruta_base = data[0].substring(0, 10);
        var cad = "";
        cad += "WIMUMO " + data[0].substring(7, 10) + " " + "<mark>detectado</mark>! <br> en IP ";
        cad += data[1];
        if (data[2] == "false") {
          cad += '<br> NO está enviando datos (configure manualmente o presione "autoconfigurar")';
        }
        else {
          cad += '<br> Enviando datos a: ';
          cad += data[3] + ":" + data[4];
        }
        cad += '<br> Nivel de batería aproximado: <span id="nivel_batt"></span>';
        document.getElementById("estado").innerHTML = cad;

        numch = parseInt(data[6]);
        var p = document.getElementById("parrafoCanales");
        for (var k = 0; k < numch; k++) {
          let btn = document.createElement("button");
          btn.innerHTML = data[7 + k].substring(11);
          posiblesChans.push(data[7 + k]);
          btn.name = "btn" + String(k);
          btn.onclick = function () {
            num = parseInt(this.name.substring(3));
            chan = posiblesChans[num];
          };
          p.appendChild(btn);
        }

        chan = ruta_base + "/raw/ch1";
      }
      else if (info_received == true 
                && data[0] == ruta_base + "/info"
                && typeof filt_batt !== 'undefined') {
        
        var nivel_batt = data[5];
        nivel_batt = filt_batt.nuevoDato(nivel_batt);
        if(nivel_batt<0) nivel_batt = 0;
        if(nivel_batt>100) nivel_batt = 100;
        var nivel_batt_pc = "";
        nivel_batt_pc += parseInt(nivel_batt) + "%";
        document.getElementById("nivel_batt").innerHTML = nivel_batt_pc;
      }

    });

    window.api.send("asynchronous-message", "pedido_iplocal");

    function updatedest(arg){
      console.log(arg.value);
      window.api.send("asynchronous-message", arg.value);
    }

    window.api.receive("iplocal", (data) => {
      console.log("datos: ");
      console.log(data);
      document.getElementById("instrucciones_iplocal").innerHTML =
        "(si la autodetección funciona puede ser: <mark>" + data[0] + "</mark>)";

    });


    

  </script>
</body>

</html>